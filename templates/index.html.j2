{% set rows = initial_hold_idxs|length %}
{% set cols = initial_hold_idxs[0]|length %}
{% set hold_types = hold_colors.keys() | list %}

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Climbing Board</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
    }
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: blueviolet;
      color: white;
      padding: 10px 20px;
    }
    .logo {
      font-size: 1.5em;
    }
    .nav-links {
      list-style: none;
      display: flex;
      gap: 20px;
    }
    .nav-links li a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }
    .hamburger {
      display: none;
      flex-direction: column;
      justify-content: space-between;
      width: 25px;
      height: 18px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
    }
    .bar {
      height: 3px;
      width: 100%;
      background-color: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }
    @media (max-width: 768px) {
      .hamburger {
        display: flex;
      }
      .nav-links {
        display: none;
        flex-direction: column;
        background: blueviolet;
        width: 94%;
        text-align: center;
        position: absolute;
        top: 60px;
        left: 3%;
        z-index: 10;
        padding: 10px 0;
      }
      .nav-links.active {
        display: flex;
      }
    }
    .hamburger.active .bar:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }
    .hamburger.active .bar:nth-child(2) {
      opacity: 0;
    }
    .hamburger.active .bar:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }
    .board {
      position: relative;
      display: inline-block;
    }
    .board img {
      max-width: 90vw;
      height: 80vh;
      object-fit: contain;
    }
    .hold {
      position: absolute;
      width: {{ 80/cols }}%;
      height: {{ 80/rows }}%;
      border-radius: 50%;
      border: 2px solid #333;
      opacity: 0.4;
      cursor: pointer;
      transform: translate(-50%, -50%);
    }

  .off   { background: transparent; border: 2px solid #aaa; }
{% for hold_type, hold_color in hold_colors.items() %}
  {% if hold_type != 'off' %}
    .{{hold_type}} { background: rgb( {{hold_color[0]}}, {{hold_color[1]}}, {{hold_color[2]}} ); }
  {% endif %}
{% endfor %}
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="logo">Climbing Board</div>
    <button class="hamburger" id="hamburger" onclick="hamburgerMenu()">
      <span class="bar"></span>
      <span class="bar"></span>
      <span class="bar"></span>
    </button>
    <ul class="nav-links" id="nav-links">
      {# <li><a href="#">Home</a></li> #}
      <button onclick="document.getElementById('settings').showModal()">Settings</button>
    </ul>
  </nav>

  <div style="margin-top:20px;">
    <button onclick="clearBoulder()">Clear</button>
  </div>

  <div class="board">
    <img src="{{ url_for('static', filename='wall.jpg') }}">
    {% for r in range(rows) %}
      {% for c in range(cols) %}
        <div class="hold {{ hold_types[initial_hold_idxs[r][c]] }}"
             data-row="{{ r }}" data-col="{{ c }}"
             style="top: {{ (r+0.5) * (100 / rows) }}%;
                    left: {{ (c+0.5) * (100 / cols) }}%;">
        </div>
      {% endfor %}
    {% endfor %}
  </div>

  <div style="margin-top:20px;">
    <input id="boulderName" placeholder="Boulder name">
    <input type="number" id="boulderDifficulty" placeholder="Difficulty" min="0">
    <button onclick="saveBoulder()" id="boulderSave">Save</button>
    <select id="boulderSelect" onchange="loadBoulder()">
      {% for name, data in initial_boulders.items() %}
        <option value="{{ name }}">{{ name }} - d{{data.difficulty}}</option>
      {% endfor %}
    </select>
  </div>

  <dialog id="settings">
    <h2>Settings</h2>
    <div>
      <label for="brightness">Brightness:</label>
      <input type="range" id="brightness" name="brightness" min="0" max="1" value="{{ config.brightness }}", step="0.1", oninput="setBrightness()">
    </div>
    <button type="button" onclick="document.getElementById('settings').close()">Close</button>
  </dialog>

<script>
document.querySelectorAll(".hold").forEach(hold => {
  hold.addEventListener("click", () => {
    const r = hold.dataset.row, c = hold.dataset.col;
    fetch("/set_hold", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({row: parseInt(r), col: parseInt(c)})
    })
    .then(res => res.json())
    .then(data => {
      hold.className = "hold " + data.hold_type;
    });
    document.getElementById("boulderDifficulty").value = "";
    document.getElementById("boulderSave").disabled = false;
  });
});

function saveBoulder() {
  const postData = {
    name: document.getElementById("boulderName").value,
    difficulty: document.getElementById("boulderDifficulty").value
  };
  if (!postData.name || !postData.difficulty) { alert("Enter a boulder name and difficulty!"); return; }
  fetch("/save", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(postData)
  }).then(res => res.json())
    .then(data => {
      let sel = document.getElementById("boulderSelect");
      sel.innerHTML = "";
      Object.entries(data.boulders).forEach(([name, difficulty]) => {
        let opt = document.createElement("option");
        opt.value = name; opt.textContent = `${name} - d${difficulty}`;
        sel.appendChild(opt);
      });
      document.getElementById("boulderSave").disabled = true;
    });
}

function loadBoulder() {
  const name = document.getElementById("boulderSelect").value;
  fetch("/load", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({name})
  }).then(res => res.json())
    .then(data => {
      setHolds(data.hold_idxs);
      document.getElementById("boulderDifficulty").value = data.difficulty;
      document.getElementById("boulderSave").disabled = true;
    });
}

function clearBoulder() {
  fetch("/clear", {
    method: "POST",
    headers: {"Content-Type": "application/json"}
  }).then(res => res.json())
    .then(data => {
      setHolds(data.hold_idxs);
      document.getElementById("boulderDifficulty").value = "";
      document.getElementById("boulderSave").disabled = true;
    });
}

function setHolds(hold_idxs)
{
  if (hold_idxs) {
    document.querySelectorAll(".hold").forEach(hold => {
      const r = parseInt(hold.dataset.row), c = parseInt(hold.dataset.col);
      const hold_idx = hold_idxs[r][c];
      const hold_types_js = {{ hold_types | tojson }};
      hold.className = "hold " + hold_types_js[hold_idx];
    });
  }
}

function hamburgerMenu()
{
  document.getElementById('hamburger').classList.toggle('active');
  document.getElementById('nav-links').classList.toggle('active');;
}

function setBrightness()
{
  const brightness = document.getElementById("brightness").value;
  fetch("/brightness", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({brightness})
  });
}

</script>
</body>
</html>
